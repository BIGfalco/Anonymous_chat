<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>チャットルーム</title>
    <link rel="stylesheet" type="text/css" href="../../static/css/chat.css">
    <script src="/webjars/sockjs-client/1.0.2/sockjs.js"></script>
    <script src="/webjars/stomp-websocket/2.3.3/stomp.js"></script>
    <script type="text/javascript">
        var stompClient = null;

        function setConnected(connected) {
            document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
            document.getElementById('response').innerHTML = '';
        }

        function connect() {
            var socket = new SockJS('/echo'); // WebSocketに接続
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/greetings', function (greeting) { // 挨拶の応答(/topic/greetings)を購読する
                    showGreeting(JSON.parse(greeting.body).content);
                });
            });
        }


        function sendNMessage() {
            var message = document.getElementById('message').value;
            stompClient.send("/app/echo", {}, JSON.stringify({'name': name})); // メッセージを送信
        }

        function showGreeting(message) {
            var response = document.getElementById('response');
            var p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(message));
            response.appendChild(p);
        }
    </script>
</head>
<body onload="connect()">
    <div class="base_view">
        <div class="room_name">
            [[${roomName}]]
        </div>
        <div id="area" class="contents scroll">
            <div class="myText">
                <div class="text">[[$myText}]]</div>
                <div class="date">[[$myDate}]]</div>
            </div>

            <div class="youText">
                <div class="text">[[$youText}]]</div>
                <div class="date">[[$youDate}]]</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <table>
            <tr>
                <td>
                    <input id="message" type="text" name="message" class="newMessage form-control" autocomplete="nope">
                </td>
                <td width="80px">
                    <button type="submit" class="btn" onclick="sendMessage()">送信</button>
                </td>
            </tr>
        </table>
    </div>

</body>
</html>